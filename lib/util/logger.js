"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Logger = undefined;

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

var _path = require("path");

var _path2 = _interopRequireDefault(_path);

var _stackTrace = require("stack-trace");

var _stackTrace2 = _interopRequireDefault(_stackTrace);

var _memoryConsole = require("./memory-console");

var _memoryConsole2 = _interopRequireDefault(_memoryConsole);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _objectWithoutProperties(obj, keys) { var target = {}; for (var i in obj) { if (keys.indexOf(i) >= 0) continue; if (!Object.prototype.hasOwnProperty.call(obj, i)) continue; target[i] = obj[i]; } return target; }
/* eslint-disable no-console */


/* https://cloud.google.com/logging/docs/reference/v2/rest/v2/LogEntry */
/* https://github.com/GoogleCloudPlatform/fluent-plugin-google-cloud/blob/master/lib/fluent/plugin/out_google_cloud.rb */
/* Note, this is actually the contents of jsonPayload, so it can contain
   arbitrary fields! */
let Logger = exports.Logger = class Logger {

  static get formatter() {
    return process.env.NODE_ENV === "development" ? Logger.PRETTY : Logger.JSON;
  }

  static get console() {
    return process.env.NODE_ENV === "test" ? new _memoryConsole2.default() : console;
  }

  constructor(producer, console = Logger.console, formatter = Logger.formatter) {
    this.producer = producer;
    this.console = console;
    this.formatter = formatter;

    Object.freeze(this);
  }

  write(severity, message, _ref) {
    let { sourceLocation } = _ref,
        context = _objectWithoutProperties(_ref, ["sourceLocation"]);

    const entry = _extends({
      "time": new Date(),
      "message": typeof message === "object" ? JSON.stringify(message) : String(message),
      severity
    }, context, {
      "logging.googleapis.com/operation": { producer: this.producer }
    });

    if (sourceLocation) {
      entry["logging.googleapis.com/sourceLocation"] = sourceLocation;
    }

    this.console.log(this.formatter(entry));
  }

  debug(message, context = {}) {
    this.write("DEBUG", message, context);
  }

  info(message, context = {}) {
    this.write("INFO", message, context);
  }

  notice(message, context = {}) {
    this.write("NOTICE", message, context);
  }

  warning(message, context = {}) {
    this.write("WARNING", message, context);
  }

  error(message, context = {}) {
    context.sourceLocation = sourceLocation();
    this.write("ERROR", message, context);
  }

  critical(message, context = {}) {
    context.sourceLocation = sourceLocation();
    this.write("CRITICAL", message, context);
  }
};
Logger.JSON = JSON.stringify;

Logger.PRETTY = entry => {
  const reset = "\x1b[0m";
  const bold = "\x1b[1m";

  const black = "\x1b[30m";
  const red = "\x1b[31m";
  const green = "\x1b[32m";
  const yellow = "\x1b[33m";
  // const blue = "\x1b[34m"

  const dateOptions = {
    year: "numeric",
    month: "short",
    day: "numeric",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
    hour12: false
  };

  const styles = {
    DEBUG: black + bold,
    INFO: reset,
    NOTICE: green + bold,
    WARNING: yellow + bold,
    ERROR: red + bold,
    CRITICAL: red + bold,
    ALERT: red + bold,
    EMERGENCY: red + bold
  };

  const time = `[${entry.time.toLocaleString("en", dateOptions)}]`;

  let http = "";
  if (entry.httpRequest) {
    const { remoteIp, requestMethod, requestUrl, status, responseSize } = entry.httpRequest;
    http = `${remoteIp || "unknown"} - ${requestMethod.toUpperCase()} ${requestUrl} ${status} ${responseSize} - `;
  }

  return `${time} ${styles[entry.severity]}${http}${entry.message}${reset}`;
};

function sourceLocation(depth = 1) {
  const caller = _stackTrace2.default.get()[depth + 1];

  return {
    file: _path2.default.relative(process.cwd(), caller.getFileName()),
    function: caller.getFunctionName() || "(anonymous)",
    line: caller.getLineNumber()
  };
}

exports.default = Logger;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlsL2xvZ2dlci5qcyJdLCJuYW1lcyI6WyJMb2dnZXIiLCJmb3JtYXR0ZXIiLCJwcm9jZXNzIiwiZW52IiwiTk9ERV9FTlYiLCJQUkVUVFkiLCJKU09OIiwiY29uc29sZSIsImNvbnN0cnVjdG9yIiwicHJvZHVjZXIiLCJPYmplY3QiLCJmcmVlemUiLCJ3cml0ZSIsInNldmVyaXR5IiwibWVzc2FnZSIsInNvdXJjZUxvY2F0aW9uIiwiY29udGV4dCIsImVudHJ5IiwiRGF0ZSIsInN0cmluZ2lmeSIsIlN0cmluZyIsImxvZyIsImRlYnVnIiwiaW5mbyIsIm5vdGljZSIsIndhcm5pbmciLCJlcnJvciIsImNyaXRpY2FsIiwicmVzZXQiLCJib2xkIiwiYmxhY2siLCJyZWQiLCJncmVlbiIsInllbGxvdyIsImRhdGVPcHRpb25zIiwieWVhciIsIm1vbnRoIiwiZGF5IiwiaG91ciIsIm1pbnV0ZSIsInNlY29uZCIsImhvdXIxMiIsInN0eWxlcyIsIkRFQlVHIiwiSU5GTyIsIk5PVElDRSIsIldBUk5JTkciLCJFUlJPUiIsIkNSSVRJQ0FMIiwiQUxFUlQiLCJFTUVSR0VOQ1kiLCJ0aW1lIiwidG9Mb2NhbGVTdHJpbmciLCJodHRwIiwiaHR0cFJlcXVlc3QiLCJyZW1vdGVJcCIsInJlcXVlc3RNZXRob2QiLCJyZXF1ZXN0VXJsIiwic3RhdHVzIiwicmVzcG9uc2VTaXplIiwidG9VcHBlckNhc2UiLCJkZXB0aCIsImNhbGxlciIsImdldCIsImZpbGUiLCJyZWxhdGl2ZSIsImN3ZCIsImdldEZpbGVOYW1lIiwiZnVuY3Rpb24iLCJnZXRGdW5jdGlvbk5hbWUiLCJsaW5lIiwiZ2V0TGluZU51bWJlciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBRUE7Ozs7QUFDQTs7OztBQUVBOzs7Ozs7O0FBSkE7OztBQTRDQTtBQUNBO0FBQ0E7O0lBZ0JhQSxNLFdBQUFBLE0sR0FBTixNQUFNQSxNQUFOLENBQWE7O0FBaURsQixhQUFXQyxTQUFYLEdBQW9EO0FB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QVA7QUFLRDs7a0JBRWN2RSxNIiwiZmlsZSI6ImxvZ2dlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIEBmbG93ICovXG4vKiBlc2xpbnQtZGlzYWJsZSBuby1jb25zb2xlICovXG5pbXBvcnQgcGF0aCBmcm9tIFwicGF0aFwiXG5pbXBvcnQgc3RhY2tUcmFjZSBmcm9tIFwic3RhY2stdHJhY2VcIlxuXG5pbXBvcnQgTWVtb3J5Q29uc29sZSBmcm9tIFwiLi9tZW1vcnktY29uc29sZVwiXG5cbmV4cG9ydCB0eXBlIEh0dHBSZXF1ZXN0ID0ge3xcbiAgcmVxdWVzdE1ldGhvZDogc3RyaW5nLFxuICByZXF1ZXN0VXJsOiBzdHJpbmcsXG4gIHJlcXVlc3RTaXplOiBudW1iZXIsXG4gIHN0YXR1czogbnVtYmVyLFxuICByZXNwb25zZVNpemU6IG51bWJlcixcbiAgdXNlckFnZW50Pzogc3RyaW5nLFxuICByZW1vdGVJcD86IHN0cmluZyxcbiAgcmVmZXJlcj86IHN0cmluZyxcbiAgbGF0ZW5jeT86IHN0cmluZyxcbiAgY2FjaGVIaXQ/OiBib29sZWFuLFxuICBjYWNoZVZhbGlkYXRlZFdpdGhPcmlnaW5TZXJ2ZXI/OiBib29sZWFuLFxufH1cblxuZXhwb3J0IHR5cGUgU291cmNlTG9jYXRpb24gPSB7fFxuICBmaWxlPzogc3RyaW5nLFxuICBmdW5jdGlvbj86IHN0cmluZyxcbiAgbGluZT86IG51bWJlcixcbnx9XG5cbmV4cG9ydCB0eXBlIE9wZXJhdGlvbiA9IHt8XG4gIGlkPzogc3RyaW5nLFxuICBwcm9kdWNlcj86IHN0cmluZyxcbiAgZmlyc3Q/OiBib29sZWFuLFxuICBsYXN0PzogYm9vbGVhbixcbnx9XG5cbmV4cG9ydCB0eXBlIExvZ1NldmVyaXR5ID0gKFxuICBcIkRFQlVHXCIgfFxuICBcIklORk9cIiB8XG4gIFwiTk9USUNFXCIgfFxuICBcIldBUk5JTkdcIiB8XG4gIFwiRVJST1JcIiB8XG4gIFwiQ1JJVElDQUxcIiB8XG4gIFwiQUxFUlRcIiB8XG4gIFwiRU1FUkdFTkNZXCJcbilcblxuLyogaHR0cHM6Ly9jbG91ZC5nb29nbGUuY29tL2xvZ2dpbmcvZG9jcy9yZWZlcmVuY2UvdjIvcmVzdC92Mi9Mb2dFbnRyeSAqL1xuLyogaHR0cHM6Ly9naXRodWIuY29tL0dvb2dsZUNsb3VkUGxhdGZvcm0vZmx1ZW50LXBsdWdpbi1nb29nbGUtY2xvdWQvYmxvYi9tYXN0ZXIvbGliL2ZsdWVudC9wbHVnaW4vb3V0X2dvb2dsZV9jbG91ZC5yYiAqL1xuLyogTm90ZSwgdGhpcyBpcyBhY3R1YWxseSB0aGUgY29udGVudHMgb2YganNvblBheWxvYWQsIHNvIGl0IGNhbiBjb250YWluXG4gICBhcmJpdHJhcnkgZmllbGRzISAqL1xuZXhwb3J0IHR5cGUgTG9nRW50cnkgPSB7XG4gIHRpbWU6IERhdGUsXG4gIG1lc3NhZ2U6IHN0cmluZyxcbiAgc2V2ZXJpdHk6IExvZ1NldmVyaXR5LFxuICBodHRwUmVxdWVzdD86IEh0dHBSZXF1ZXN0LFxuICBcImxvZ2dpbmcuZ29vZ2xlYXBpcy5jb20vc291cmNlTG9jYXRpb25cIj86IFNvdXJjZUxvY2F0aW9uLFxuICBcImxvZ2dpbmcuZ29vZ2xlYXBpcy5jb20vb3BlcmF0aW9uXCI/OiBPcGVyYXRpb24sXG59XG5cbmV4cG9ydCB0eXBlIExvZ0NvbnRleHQgPSB7XG4gIGh0dHBSZXF1ZXN0PzogSHR0cFJlcXVlc3QsXG4gIHNvdXJjZUxvY2F0aW9uPzogU291cmNlTG9jYXRpb24sXG59XG5cbmV4cG9ydCBjbGFzcyBMb2dnZXIge1xuICBwcm9kdWNlcjogc3RyaW5nXG4gIGNvbnNvbGU6IGNvbnNvbGUuQ29uc29sZVxuICBmb3JtYXR0ZXI6IExvZ0VudHJ5ID0+IHN0cmluZ1xuXG4gIHN0YXRpYyBKU09OID0gSlNPTi5zdHJpbmdpZnlcblxuICBzdGF0aWMgUFJFVFRZID0gKGVudHJ5OiBMb2dFbnRyeSkgPT4ge1xuICAgIGNvbnN0IHJlc2V0ID0gXCJcXHgxYlswbVwiXG4gICAgY29uc3QgYm9sZCA9IFwiXFx4MWJbMW1cIlxuXG4gICAgY29uc3QgYmxhY2sgPSBcIlxceDFiWzMwbVwiXG4gICAgY29uc3QgcmVkID0gXCJcXHgxYlszMW1cIlxuICAgIGNvbnN0IGdyZWVuID0gXCJcXHgxYlszMm1cIlxuICAgIGNvbnN0IHllbGxvdyA9IFwiXFx4MWJbMzNtXCJcbiAgICAvLyBjb25zdCBibHVlID0gXCJcXHgxYlszNG1cIlxuXG4gICAgY29uc3QgZGF0ZU9wdGlvbnMgPSB7XG4gICAgICB5ZWFyOiBcIm51bWVyaWNcIixcbiAgICAgIG1vbnRoOiBcInNob3J0XCIsXG4gICAgICBkYXk6IFwibnVtZXJpY1wiLFxuICAgICAgaG91cjogXCIyLWRpZ2l0XCIsXG4gICAgICBtaW51dGU6IFwiMi1kaWdpdFwiLFxuICAgICAgc2Vjb25kOiBcIjItZGlnaXRcIixcbiAgICAgIGhvdXIxMjogZmFsc2UsXG4gICAgfVxuXG4gICAgY29uc3Qgc3R5bGVzID0ge1xuICAgICAgREVCVUc6IGJsYWNrICsgYm9sZCxcbiAgICAgIElORk86IHJlc2V0LFxuICAgICAgTk9USUNFOiBncmVlbiArIGJvbGQsXG4gICAgICBXQVJOSU5HOiB5ZWxsb3cgKyBib2xkLFxuICAgICAgRVJST1I6IHJlZCArIGJvbGQsXG4gICAgICBDUklUSUNBTDogcmVkICsgYm9sZCxcbiAgICAgIEFMRVJUOiByZWQgKyBib2xkLFxuICAgICAgRU1FUkdFTkNZOiByZWQgKyBib2xkLFxuICAgIH1cblxuICAgIGNvbnN0IHRpbWUgPSBgWyR7ZW50cnkudGltZS50b0xvY2FsZVN0cmluZyhcImVuXCIsIGRhdGVPcHRpb25zKX1dYFxuXG4gICAgbGV0IGh0dHAgPSBcIlwiXG4gICAgaWYgKGVudHJ5Lmh0dHBSZXF1ZXN0KSB7XG4gICAgICBjb25zdCB7cmVtb3RlSXAsIHJlcXVlc3RNZXRob2QsIHJlcXVlc3RVcmwsIHN0YXR1cywgcmVzcG9uc2VTaXplfSA9IGVudHJ5Lmh0dHBSZXF1ZXN0XG4gICAgICBodHRwID0gYCR7cmVtb3RlSXAgfHwgXCJ1bmtub3duXCJ9IC0gJHtyZXF1ZXN0TWV0aG9kLnRvVXBwZXJDYXNlKCl9ICR7cmVxdWVzdFVybH0gJHtzdGF0dXN9ICR7cmVzcG9uc2VTaXplfSAtIGBcbiAgICB9XG5cbiAgICByZXR1cm4gYCR7dGltZX0gJHtzdHlsZXNbZW50cnkuc2V2ZXJpdHldfSR7aHR0cH0ke2VudHJ5Lm1lc3NhZ2V9JHtyZXNldH1gXG4gIH1cblxuICBzdGF0aWMgZ2V0IGZvcm1hdHRlcigpOiAoZW50cnk6IExvZ0VudHJ5KSA9PiBzdHJpbmcge1xuICAgIHJldHVybiBwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gXCJkZXZlbG9wbWVudFwiID8gTG9nZ2VyLlBSRVRUWSA6IExvZ2dlci5KU09OXG4gIH1cblxuICBzdGF0aWMgZ2V0IGNvbnNvbGUoKTogY29uc29sZS5Db25zb2xlIHtcbiAgICByZXR1cm4gcHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09IFwidGVzdFwiID8gbmV3IE1lbW9yeUNvbnNvbGUgOiBjb25zb2xlXG4gIH1cblxuICBjb25zdHJ1Y3Rvcihwcm9kdWNlcjogc3RyaW5nLCBjb25zb2xlOiBjb25zb2xlLkNvbnNvbGUgPSBMb2dnZXIuY29uc29sZSxcbiAgICBmb3JtYXR0ZXI6IExvZ0VudHJ5ID0+IHN0cmluZyA9IExvZ2dlci5mb3JtYXR0ZXIpIHtcbiAgICB0aGlzLnByb2R1Y2VyID0gcHJvZHVjZXJcbiAgICB0aGlzLmNvbnNvbGUgPSBjb25zb2xlXG4gICAgdGhpcy5mb3JtYXR0ZXIgPSBmb3JtYXR0ZXJcblxuICAgIE9iamVjdC5mcmVlemUodGhpcylcbiAgfVxuXG4gIHdyaXRlKHNldmVyaXR5OiBMb2dTZXZlcml0eSwgbWVzc2FnZTogbWl4ZWQsIHtzb3VyY2VMb2NhdGlvbiwgLi4uY29udGV4dH06IExvZ0NvbnRleHQpIHtcbiAgICBjb25zdCBlbnRyeTogTG9nRW50cnkgPSB7XG4gICAgICBcInRpbWVcIjogbmV3IERhdGUsXG4gICAgICBcIm1lc3NhZ2VcIjogdHlwZW9mIG1lc3NhZ2UgPT09IFwib2JqZWN0XCIgPyBKU09OLnN0cmluZ2lmeShtZXNzYWdlKSA6IFN0cmluZyhtZXNzYWdlKSxcbiAgICAgIHNldmVyaXR5LFxuICAgICAgLi4uY29udGV4dCxcbiAgICAgIFwibG9nZ2luZy5nb29nbGVhcGlzLmNvbS9vcGVyYXRpb25cIjoge3Byb2R1Y2VyOiB0aGlzLnByb2R1Y2VyfSxcbiAgICB9XG5cbiAgICBpZiAoc291cmNlTG9jYXRpb24pIHtcbiAgICAgIGVudHJ5W1wibG9nZ2luZy5nb29nbGVhcGlzLmNvbS9zb3VyY2VMb2NhdGlvblwiXSA9IHNvdXJjZUxvY2F0aW9uXG4gICAgfVxuXG4gICAgdGhpcy5jb25zb2xlLmxvZyh0aGlzLmZvcm1hdHRlcihlbnRyeSkpXG4gIH1cblxuICBkZWJ1ZyhtZXNzYWdlOiBtaXhlZCwgY29udGV4dDogTG9nQ29udGV4dCA9IHt9KSB7XG4gICAgdGhpcy53cml0ZShcIkRFQlVHXCIsIG1lc3NhZ2UsIGNvbnRleHQpXG4gIH1cblxuICBpbmZvKG1lc3NhZ2U6IG1peGVkLCBjb250ZXh0OiBMb2dDb250ZXh0ID0ge30pIHtcbiAgICB0aGlzLndyaXRlKFwiSU5GT1wiLCBtZXNzYWdlLCBjb250ZXh0KVxuICB9XG5cbiAgbm90aWNlKG1lc3NhZ2U6IG1peGVkLCBjb250ZXh0OiBMb2dDb250ZXh0ID0ge30pIHtcbiAgICB0aGlzLndyaXRlKFwiTk9USUNFXCIsIG1lc3NhZ2UsIGNvbnRleHQpXG4gIH1cblxuICB3YXJuaW5nKG1lc3NhZ2U6IG1peGVkLCBjb250ZXh0OiBMb2dDb250ZXh0ID0ge30pIHtcbiAgICB0aGlzLndyaXRlKFwiV0FSTklOR1wiLCBtZXNzYWdlLCBjb250ZXh0KVxuICB9XG5cbiAgZXJyb3IobWVzc2FnZTogbWl4ZWQsIGNvbnRleHQ6IExvZ0NvbnRleHQgPSB7fSkge1xuICAgIGNvbnRleHQuc291cmNlTG9jYXRpb24gPSBzb3VyY2VMb2NhdGlvbigpXG4gICAgdGhpcy53cml0ZShcIkVSUk9SXCIsIG1lc3NhZ2UsIGNvbnRleHQpXG4gIH1cblxuICBjcml0aWNhbChtZXNzYWdlOiBtaXhlZCwgY29udGV4dDogTG9nQ29udGV4dCA9IHt9KSB7XG4gICAgY29udGV4dC5zb3VyY2VMb2NhdGlvbiA9IHNvdXJjZUxvY2F0aW9uKClcbiAgICB0aGlzLndyaXRlKFwiQ1JJVElDQUxcIiwgbWVzc2FnZSwgY29udGV4dClcbiAgfVxufVxuXG5mdW5jdGlvbiBzb3VyY2VMb2NhdGlvbihkZXB0aDogbnVtYmVyID0gMSk6IFNvdXJjZUxvY2F0aW9uIHtcbiAgY29uc3QgY2FsbGVyID0gc3RhY2tUcmFjZS5nZXQoKVtkZXB0aCArIDFdXG5cbiAgcmV0dXJuIHtcbiAgICBmaWxlOiBwYXRoLnJlbGF0aXZlKHByb2Nlc3MuY3dkKCksIGNhbGxlci5nZXRGaWxlTmFtZSgpKSxcbiAgICBmdW5jdGlvbjogY2FsbGVyLmdldEZ1bmN0aW9uTmFtZSgpIHx8IFwiKGFub255bW91cylcIixcbiAgICBsaW5lOiBjYWxsZXIuZ2V0TGluZU51bWJlcigpLFxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IExvZ2dlclxuIl19