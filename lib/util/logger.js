"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Logger = undefined;

var _path = require("path");

var _path2 = _interopRequireDefault(_path);

var _stackTrace = require("stack-trace");

var _stackTrace2 = _interopRequireDefault(_stackTrace);

var _memoryConsole = require("./memory-console");

var _memoryConsole2 = _interopRequireDefault(_memoryConsole);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/* https://cloud.google.com/logging/docs/reference/v2/rest/v2/LogEntry */
/* https://github.com/GoogleCloudPlatform/fluent-plugin-google-cloud/blob/master/lib/fluent/plugin/out_google_cloud.rb */
/* Note, this is actually the contents of jsonPayload, so it can contain
   arbitrary fields! */
let Logger = exports.Logger = class Logger {

  static get formatter() {
    return process.env.NODE_ENV === "development" ? Logger.PRETTY : Logger.JSON;
  }

  static get console() {
    return process.env.NODE_ENV === "test" ? new _memoryConsole2.default() : console;
  }

  constructor(console = Logger.console, formatter = Logger.formatter) {
    this.console = console;
    this.formatter = formatter;

    Object.freeze(this);
  }

  write(severity, message, context) {
    const entry = {
      time: new Date(),
      message: typeof message === "object" ? JSON.stringify(message) : String(message),
      severity
    };

    this.console.log(this.formatter(Object.assign(entry, context)));
  }

  debug(message, context = {}) {
    this.write("DEBUG", message, context);
  }

  info(message, context = {}) {
    this.write("INFO", message, context);
  }

  notice(message, context = {}) {
    this.write("NOTICE", message, context);
  }

  warning(message, context = {}) {
    this.write("WARNING", message, context);
  }

  error(message, context = {}) {
    context["logging.googleapis.com/sourceLocation"] = sourceLocation();
    this.write("ERROR", message, context);
  }

  critical(message, context = {}) {
    context["logging.googleapis.com/sourceLocation"] = sourceLocation();
    this.write("CRITICAL", message, context);
  }
};
/* eslint-disable no-console */

Logger.JSON = JSON.stringify;

Logger.PRETTY = entry => {
  const reset = "\x1b[0m";
  const bold = "\x1b[1m";

  const black = "\x1b[30m";
  const red = "\x1b[31m";
  const green = "\x1b[32m";
  const yellow = "\x1b[33m";
  // const blue = "\x1b[34m"

  const dateOptions = {
    year: "numeric",
    month: "short",
    day: "numeric",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
    hour12: false
  };

  const styles = {
    DEBUG: black + bold,
    INFO: reset,
    NOTICE: green + bold,
    WARNING: yellow + bold,
    ERROR: red + bold,
    CRITICAL: red + bold,
    ALERT: red + bold,
    EMERGENCY: red + bold
  };

  const time = `[${entry.time.toLocaleString("en", dateOptions)}]`;

  let http = "";
  if (entry.httpRequest) {
    const { remoteIp, requestMethod, requestUrl, status, responseSize } = entry.httpRequest;
    http = `${remoteIp || "unknown"} - ${requestMethod.toUpperCase()} ${requestUrl} ${status} ${responseSize} - `;
  }

  return `${time} ${styles[entry.severity]}${http}${entry.message}${reset}`;
};

function sourceLocation(depth = 1) {
  const caller = _stackTrace2.default.get()[depth + 1];

  return {
    file: _path2.default.relative(process.cwd(), caller.getFileName()),
    function: caller.getFunctionName() || "(anonymous)",
    line: caller.getLineNumber()
  };
}

exports.default = Logger;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlsL2xvZ2dlci5qcyJdLCJuYW1lcyI6WyJMb2dnZXIiLCJmb3JtYXR0ZXIiLCJwcm9jZXNzIiwiZW52IiwiTk9ERV9FTlYiLCJQUkVUVFkiLCJKU09OIiwiY29uc29sZSIsImNvbnN0cnVjdG9yIiwiT2JqZWN0IiwiZnJlZXplIiwid3JpdGUiLCJzZXZlcml0eSIsIm1lc3NhZ2UiLCJjb250ZXh0IiwiZW50cnkiLCJ0aW1lIiwiRGF0ZSIsInN0cmluZ2lmeSIsIlN0cmluZyIsImxvZyIsImFzc2lnbiIsImRlYnVnIiwiaW5mbyIsIm5vdGljZSIsIndhcm5pbmciLCJlcnJvciIsInNvdXJjZUxvY2F0aW9uIiwiY3JpdGljYWwiLCJyZXNldCIsImJvbGQiLCJibGFjayIsInJlZCIsImdyZWVuIiwieWVsbG93IiwiZGF0ZU9wdGlvbnMiLCJ5ZWFyIiwibW9udGgiLCJkYXkiLCJob3VyIiwibWludXRlIiwic2Vjb25kIiwiaG91cjEyIiwic3R5bGVzIiwiREVCVUciLCJJTkZPIiwiTk9USUNFIiwiV0FSTklORyIsIkVSUk9SIiwiQ1JJVElDQUwiLCJBTEVSVCIsIkVNRVJHRU5DWSIsInRvTG9jYWxlU3RyaW5nIiwiaHR0cCIsImh0dHBSZXF1ZXN0IiwicmVtb3RlSXAiLCJyZXF1ZXN0TWV0aG9kIiwicmVxdWVzdFVybCIsInN0YXR1cyIsInJlc3BvbnNlU2l6ZSIsInRvVXBwZXJDYXNlIiwiZGVwdGgiLCJjYWxsZXIiLCJnZXQiLCJmaWxlIiwicmVsYXRpdmUiLCJjd2QiLCJnZXRGaWxlTmFtZSIsImZ1bmN0aW9uIiwiZ2V0RnVuY3Rpb25OYW1lIiwibGluZSIsImdldExpbmVOdW1iZXIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFFQTs7OztBQUNBOzs7O0FBRUE7Ozs7OztBQWlDQTtBQUNBO0FBQ0E7O0lBZWFBLE0sV0FBQUEsTSxHQUFOLE1BQU1BLE1BQU4sQ0FBYTs7QUFnRGxCLGFBQVdDLFNBQVgsR0FBb0Q7QUFDbEQsV0FBT0MsUUFB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QUFNYm1CLGNBQVVqQixNQUFNRixJQU5IO0FBT2JvQixXQUFPbEIsTUFBTUYsSUFQQTtBQVFicUIsZUFBV25CLE1BQU1GO0FBUkosR0FBZjs7QUFXQSxRQUFNZCxPQUFRLElBQUdELE1BQU1DLElBQU4sQ0FBV29DLGNBQVgsQ0FBMEIsSUFBMUIsRUFBZ0NqQixXQUFoQyxDQUE2QyxHQUE5RDs7QUFFQSxNQUFJa0IsT0FBTyxFQUFYO0FBQ0EsTUFBSXRDLE1BQU11QyxXQUFWLEVBQXVCO0FBQ3JCLFVBQU0sRUFBQ0MsUUFBRCxFQUFXQyxhQUFYLEVBQTBCQyxVQUExQixFQUFzQ0MsTUFBdEMsRUFBOENDLFlBQTlDLEtBQThENUMsTUFBTXVDLFdBQTFFO0FBQ0FELFdBQVEsR0FBRUUsWUFBWSxTQUFVLE1BQUtDLGNBQWNJLFdBQWQsRUFBNEIsSUFBR0gsVUFBVyxJQUFHQyxNQUFPLElBQUdDLFlBQWEsS0FBekc7QUFDRDs7QUFFRCxTQUFRLEdBQUUzQyxJQUFLLElBQUcyQixPQUFPNUIsTUFBTUgsUUFBYixDQUF1QixHQUFFeUMsSUFBSyxHQUFFdEMsTUFBTUYsT0FBUSxHQUFFZ0IsS0FBTSxFQUF4RTtBQUNELEM7O0FBc0RILFNBQVNGLGNBQVQsQ0FBd0JrQyxRQUFnQixDQUF4QyxFQUEyRDtBQUN6RCxRQUFNQyxTQUFTLHFCQUFXQyxHQUFYLEdBQWlCRixRQUFRLENBQXpCLENBQWY7O0FBRUEsU0FBTztBQUNMRyxVQUFNLGVBQUtDLFFBQUwsQ0FBYy9ELFFBQVFnRSxHQUFSLEVBQWQsRUFBNkJKLE9BQU9LLFdBQVAsRUFBN0IsQ0FERDtBQUVMQyxjQUFVTixPQUFPTyxlQUFQLE1BQTRCLGFBRmpDO0FBR0xDLFVBQU1SLE9BQU9TLGFBQVA7QUFIRCxHQUFQO0FBS0Q7O2tCQUVjdkUsTSIsImZpbGUiOiJsb2dnZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBAZmxvdyAqL1xuLyogZXNsaW50LWRpc2FibGUgbm8tY29uc29sZSAqL1xuaW1wb3J0IHBhdGggZnJvbSBcInBhdGhcIlxuaW1wb3J0IHN0YWNrVHJhY2UgZnJvbSBcInN0YWNrLXRyYWNlXCJcblxuaW1wb3J0IE1lbW9yeUNvbnNvbGUgZnJvbSBcIi4vbWVtb3J5LWNvbnNvbGVcIlxuXG5leHBvcnQgdHlwZSBIdHRwUmVxdWVzdCA9IHt8XG4gIHJlcXVlc3RNZXRob2Q6IHN0cmluZyxcbiAgcmVxdWVzdFVybDogc3RyaW5nLFxuICByZXF1ZXN0U2l6ZTogbnVtYmVyLFxuICBzdGF0dXM6IG51bWJlcixcbiAgcmVzcG9uc2VTaXplOiBudW1iZXIsXG4gIHVzZXJBZ2VudD86IHN0cmluZyxcbiAgcmVtb3RlSXA/OiBzdHJpbmcsXG4gIHJlZmVyZXI/OiBzdHJpbmcsXG4gIGxhdGVuY3k/OiBzdHJpbmcsXG4gIGNhY2hlSGl0PzogYm9vbGVhbixcbiAgY2FjaGVWYWxpZGF0ZWRXaXRoT3JpZ2luU2VydmVyPzogYm9vbGVhbixcbnx9XG5cbmV4cG9ydCB0eXBlIFNvdXJjZUxvY2F0aW9uID0ge3xcbiAgZmlsZT86IHN0cmluZyxcbiAgZnVuY3Rpb24/OiBzdHJpbmcsXG4gIGxpbmU/OiBudW1iZXIsXG58fVxuXG5leHBvcnQgdHlwZSBMb2dTZXZlcml0eSA9IChcbiAgXCJERUJVR1wiIHxcbiAgXCJJTkZPXCIgfFxuICBcIk5PVElDRVwiIHxcbiAgXCJXQVJOSU5HXCIgfFxuICBcIkVSUk9SXCIgfFxuICBcIkNSSVRJQ0FMXCIgfFxuICBcIkFMRVJUXCIgfFxuICBcIkVNRVJHRU5DWVwiXG4pXG5cbi8qIGh0dHBzOi8vY2xvdWQuZ29vZ2xlLmNvbS9sb2dnaW5nL2RvY3MvcmVmZXJlbmNlL3YyL3Jlc3QvdjIvTG9nRW50cnkgKi9cbi8qIGh0dHBzOi8vZ2l0aHViLmNvbS9Hb29nbGVDbG91ZFBsYXRmb3JtL2ZsdWVudC1wbHVnaW4tZ29vZ2xlLWNsb3VkL2Jsb2IvbWFzdGVyL2xpYi9mbHVlbnQvcGx1Z2luL291dF9nb29nbGVfY2xvdWQucmIgKi9cbi8qIE5vdGUsIHRoaXMgaXMgYWN0dWFsbHkgdGhlIGNvbnRlbnRzIG9mIGpzb25QYXlsb2FkLCBzbyBpdCBjYW4gY29udGFpblxuICAgYXJiaXRyYXJ5IGZpZWxkcyEgKi9cbmV4cG9ydCB0eXBlIExvZ0VudHJ5ID0ge1xuICB0aW1lOiBEYXRlLFxuICBtZXNzYWdlOiBzdHJpbmcsXG4gIHNldmVyaXR5OiBMb2dTZXZlcml0eSxcbiAgaHR0cFJlcXVlc3Q/OiBIdHRwUmVxdWVzdCxcbiAgXCJsb2dnaW5nLmdvb2dsZWFwaXMuY29tL3NvdXJjZUxvY2F0aW9uXCI/OiBTb3VyY2VMb2NhdGlvbixcbn1cblxuZXhwb3J0IHR5cGUgTG9nQ29udGV4dCA9IHtcbiAgaHR0cFJlcXVlc3Q/OiBIdHRwUmVxdWVzdCxcbiAgXCJsb2dnaW5nLmdvb2dsZWFwaXMuY29tL3NvdXJjZUxvY2F0aW9uXCI/OiBTb3VyY2VMb2NhdGlvbixcbn1cblxuZXhwb3J0IGNsYXNzIExvZ2dlciB7XG4gIGNvbnNvbGU6IGNvbnNvbGUuQ29uc29sZVxuICBmb3JtYXR0ZXI6IExvZ0VudHJ5ID0+IHN0cmluZ1xuXG4gIHN0YXRpYyBKU09OID0gSlNPTi5zdHJpbmdpZnlcblxuICBzdGF0aWMgUFJFVFRZID0gKGVudHJ5OiBMb2dFbnRyeSkgPT4ge1xuICAgIGNvbnN0IHJlc2V0ID0gXCJcXHgxYlswbVwiXG4gICAgY29uc3QgYm9sZCA9IFwiXFx4MWJbMW1cIlxuXG4gICAgY29uc3QgYmxhY2sgPSBcIlxceDFiWzMwbVwiXG4gICAgY29uc3QgcmVkID0gXCJcXHgxYlszMW1cIlxuICAgIGNvbnN0IGdyZWVuID0gXCJcXHgxYlszMm1cIlxuICAgIGNvbnN0IHllbGxvdyA9IFwiXFx4MWJbMzNtXCJcbiAgICAvLyBjb25zdCBibHVlID0gXCJcXHgxYlszNG1cIlxuXG4gICAgY29uc3QgZGF0ZU9wdGlvbnMgPSB7XG4gICAgICB5ZWFyOiBcIm51bWVyaWNcIixcbiAgICAgIG1vbnRoOiBcInNob3J0XCIsXG4gICAgICBkYXk6IFwibnVtZXJpY1wiLFxuICAgICAgaG91cjogXCIyLWRpZ2l0XCIsXG4gICAgICBtaW51dGU6IFwiMi1kaWdpdFwiLFxuICAgICAgc2Vjb25kOiBcIjItZGlnaXRcIixcbiAgICAgIGhvdXIxMjogZmFsc2UsXG4gICAgfVxuXG4gICAgY29uc3Qgc3R5bGVzID0ge1xuICAgICAgREVCVUc6IGJsYWNrICsgYm9sZCxcbiAgICAgIElORk86IHJlc2V0LFxuICAgICAgTk9USUNFOiBncmVlbiArIGJvbGQsXG4gICAgICBXQVJOSU5HOiB5ZWxsb3cgKyBib2xkLFxuICAgICAgRVJST1I6IHJlZCArIGJvbGQsXG4gICAgICBDUklUSUNBTDogcmVkICsgYm9sZCxcbiAgICAgIEFMRVJUOiByZWQgKyBib2xkLFxuICAgICAgRU1FUkdFTkNZOiByZWQgKyBib2xkLFxuICAgIH1cblxuICAgIGNvbnN0IHRpbWUgPSBgWyR7ZW50cnkudGltZS50b0xvY2FsZVN0cmluZyhcImVuXCIsIGRhdGVPcHRpb25zKX1dYFxuXG4gICAgbGV0IGh0dHAgPSBcIlwiXG4gICAgaWYgKGVudHJ5Lmh0dHBSZXF1ZXN0KSB7XG4gICAgICBjb25zdCB7cmVtb3RlSXAsIHJlcXVlc3RNZXRob2QsIHJlcXVlc3RVcmwsIHN0YXR1cywgcmVzcG9uc2VTaXplfSA9IGVudHJ5Lmh0dHBSZXF1ZXN0XG4gICAgICBodHRwID0gYCR7cmVtb3RlSXAgfHwgXCJ1bmtub3duXCJ9IC0gJHtyZXF1ZXN0TWV0aG9kLnRvVXBwZXJDYXNlKCl9ICR7cmVxdWVzdFVybH0gJHtzdGF0dXN9ICR7cmVzcG9uc2VTaXplfSAtIGBcbiAgICB9XG5cbiAgICByZXR1cm4gYCR7dGltZX0gJHtzdHlsZXNbZW50cnkuc2V2ZXJpdHldfSR7aHR0cH0ke2VudHJ5Lm1lc3NhZ2V9JHtyZXNldH1gXG4gIH1cblxuICBzdGF0aWMgZ2V0IGZvcm1hdHRlcigpOiAoZW50cnk6IExvZ0VudHJ5KSA9PiBzdHJpbmcge1xuICAgIHJldHVybiBwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gXCJkZXZlbG9wbWVudFwiID8gTG9nZ2VyLlBSRVRUWSA6IExvZ2dlci5KU09OXG4gIH1cblxuICBzdGF0aWMgZ2V0IGNvbnNvbGUoKTogY29uc29sZS5Db25zb2xlIHtcbiAgICByZXR1cm4gcHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09IFwidGVzdFwiID8gbmV3IE1lbW9yeUNvbnNvbGUgOiBjb25zb2xlXG4gIH1cblxuICBjb25zdHJ1Y3Rvcihjb25zb2xlOiBjb25zb2xlLkNvbnNvbGUgPSBMb2dnZXIuY29uc29sZSwgZm9ybWF0dGVyOiBMb2dFbnRyeSA9PiBzdHJpbmcgPSBMb2dnZXIuZm9ybWF0dGVyKSB7XG4gICAgdGhpcy5jb25zb2xlID0gY29uc29sZVxuICAgIHRoaXMuZm9ybWF0dGVyID0gZm9ybWF0dGVyXG5cbiAgICBPYmplY3QuZnJlZXplKHRoaXMpXG4gIH1cblxuICB3cml0ZShzZXZlcml0eTogTG9nU2V2ZXJpdHksIG1lc3NhZ2U6IG1peGVkLCBjb250ZXh0OiBMb2dDb250ZXh0KSB7XG4gICAgY29uc3QgZW50cnk6IExvZ0VudHJ5ID0ge1xuICAgICAgdGltZTogbmV3IERhdGUsXG4gICAgICBtZXNzYWdlOiB0eXBlb2YgbWVzc2FnZSA9PT0gXCJvYmplY3RcIiA/IEpTT04uc3RyaW5naWZ5KG1lc3NhZ2UpIDogU3RyaW5nKG1lc3NhZ2UpLFxuICAgICAgc2V2ZXJpdHksXG4gICAgfVxuXG4gICAgdGhpcy5jb25zb2xlLmxvZyh0aGlzLmZvcm1hdHRlcihPYmplY3QuYXNzaWduKGVudHJ5LCBjb250ZXh0KSkpXG4gIH1cblxuICBkZWJ1ZyhtZXNzYWdlOiBtaXhlZCwgY29udGV4dDogTG9nQ29udGV4dCA9IHt9KSB7XG4gICAgdGhpcy53cml0ZShcIkRFQlVHXCIsIG1lc3NhZ2UsIGNvbnRleHQpXG4gIH1cblxuICBpbmZvKG1lc3NhZ2U6IG1peGVkLCBjb250ZXh0OiBMb2dDb250ZXh0ID0ge30pIHtcbiAgICB0aGlzLndyaXRlKFwiSU5GT1wiLCBtZXNzYWdlLCBjb250ZXh0KVxuICB9XG5cbiAgbm90aWNlKG1lc3NhZ2U6IG1peGVkLCBjb250ZXh0OiBMb2dDb250ZXh0ID0ge30pIHtcbiAgICB0aGlzLndyaXRlKFwiTk9USUNFXCIsIG1lc3NhZ2UsIGNvbnRleHQpXG4gIH1cblxuICB3YXJuaW5nKG1lc3NhZ2U6IG1peGVkLCBjb250ZXh0OiBMb2dDb250ZXh0ID0ge30pIHtcbiAgICB0aGlzLndyaXRlKFwiV0FSTklOR1wiLCBtZXNzYWdlLCBjb250ZXh0KVxuICB9XG5cbiAgZXJyb3IobWVzc2FnZTogbWl4ZWQsIGNvbnRleHQ6IExvZ0NvbnRleHQgPSB7fSkge1xuICAgIGNvbnRleHRbXCJsb2dnaW5nLmdvb2dsZWFwaXMuY29tL3NvdXJjZUxvY2F0aW9uXCJdID0gc291cmNlTG9jYXRpb24oKVxuICAgIHRoaXMud3JpdGUoXCJFUlJPUlwiLCBtZXNzYWdlLCBjb250ZXh0KVxuICB9XG5cbiAgY3JpdGljYWwobWVzc2FnZTogbWl4ZWQsIGNvbnRleHQ6IExvZ0NvbnRleHQgPSB7fSkge1xuICAgIGNvbnRleHRbXCJsb2dnaW5nLmdvb2dsZWFwaXMuY29tL3NvdXJjZUxvY2F0aW9uXCJdID0gc291cmNlTG9jYXRpb24oKVxuICAgIHRoaXMud3JpdGUoXCJDUklUSUNBTFwiLCBtZXNzYWdlLCBjb250ZXh0KVxuICB9XG59XG5cbmZ1bmN0aW9uIHNvdXJjZUxvY2F0aW9uKGRlcHRoOiBudW1iZXIgPSAxKTogU291cmNlTG9jYXRpb24ge1xuICBjb25zdCBjYWxsZXIgPSBzdGFja1RyYWNlLmdldCgpW2RlcHRoICsgMV1cblxuICByZXR1cm4ge1xuICAgIGZpbGU6IHBhdGgucmVsYXRpdmUocHJvY2Vzcy5jd2QoKSwgY2FsbGVyLmdldEZpbGVOYW1lKCkpLFxuICAgIGZ1bmN0aW9uOiBjYWxsZXIuZ2V0RnVuY3Rpb25OYW1lKCkgfHwgXCIoYW5vbnltb3VzKVwiLFxuICAgIGxpbmU6IGNhbGxlci5nZXRMaW5lTnVtYmVyKCksXG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgTG9nZ2VyXG4iXX0=