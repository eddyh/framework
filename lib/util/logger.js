"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Logger = undefined;

var _path = require("path");

var _path2 = _interopRequireDefault(_path);

var _stackTrace = require("stack-trace");

var _stackTrace2 = _interopRequireDefault(_stackTrace);

var _hostPkg = require("./host-pkg");

var _hostPkg2 = _interopRequireDefault(_hostPkg);

var _memoryConsole = require("./memory-console");

var _memoryConsole2 = _interopRequireDefault(_memoryConsole);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/* https://cloud.google.com/logging/docs/reference/v2/rest/v2/LogEntry */
/* https://github.com/GoogleCloudPlatform/fluent-plugin-google-cloud/blob/master/lib/fluent/plugin/out_google_cloud.rb */
/* https://github.com/GoogleCloudPlatform/fluent-plugin-google-cloud/issues/99 */
/* Note, this also has the contents of jsonPayload, so it can contain
   arbitrary fields! */
const errorSeverity = new Set(["ERROR", "CRITICAL", "ALERT", "EMERGENCY"]);

let Logger = exports.Logger = class Logger {

  static get formatter() {
    return process.env.NODE_ENV === "development" ? Logger.PRETTY : Logger.JSON;
  }

  static get console() {
    return process.env.NODE_ENV === "test" ? new _memoryConsole2.default() : console;
  }

  static get service() {
    return {
      service: _hostPkg2.default.name,
      version: _hostPkg2.default.version
    };
  }

  constructor(console = Logger.console, formatter = Logger.formatter, service = Logger.service) {
    this.console = console;
    this.formatter = formatter;
    this.service = service;

    Object.freeze(this);
  }

  write(severity, message, context) {
    const entry = {
      time: new Date(),
      message: typeof message === "object" ? JSON.stringify(message) : String(message),
      serviceContext: this.service,
      severity
    };

    if (errorSeverity.has(severity)) {
      entry.context = { reportLocation: reportLocation() };
    }

    this.console.log(this.formatter(Object.assign(entry, context)));
  }

  debug(message, context = {}) {
    this.write("DEBUG", message, context);
  }

  info(message, context = {}) {
    this.write("INFO", message, context);
  }

  notice(message, context = {}) {
    this.write("NOTICE", message, context);
  }

  warning(message, context = {}) {
    this.write("WARNING", message, context);
  }

  error(message, context = {}) {
    this.write("ERROR", message, context);
  }

  critical(message, context = {}) {
    this.write("CRITICAL", message, context);
  }
};
Logger.JSON = JSON.stringify;

Logger.PRETTY = entry => {
  const reset = "\x1b[0m";
  const bold = "\x1b[1m";

  const black = "\x1b[30m";
  const red = "\x1b[31m";
  const green = "\x1b[32m";
  const yellow = "\x1b[33m";
  // const blue = "\x1b[34m"

  const dateOptions = {
    year: "numeric",
    month: "short",
    day: "numeric",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
    hour12: false
  };

  const styles = {
    DEBUG: black + bold,
    INFO: reset,
    NOTICE: green + bold,
    WARNING: yellow + bold,
    ERROR: red + bold,
    CRITICAL: red + bold,
    ALERT: red + bold,
    EMERGENCY: red + bold
  };

  const time = `[${entry.time.toLocaleString("en", dateOptions)}]`;

  let http = "";
  if (entry.httpRequest) {
    const { remoteIp, requestMethod, requestUrl, status, responseSize } = entry.httpRequest;
    http = `${remoteIp || "unknown"} - ${requestMethod.toUpperCase()} ${requestUrl} ${status} ${responseSize} - `;
  }

  return `${time} ${styles[entry.severity]}${http}${entry.message}${reset}`;
};

function reportLocation(depth = 2) {
  const caller = _stackTrace2.default.get()[depth + 1];

  return {
    filePath: _path2.default.relative(process.cwd(), caller.getFileName()),
    lineNumber: caller.getLineNumber(),
    functionName: caller.getFunctionName() || "<anonymous>"
  };
}

exports.default = Logger;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlsL2xvZ2dlci5qcyJdLCJuYW1lcyI6WyJlcnJvclNldmVyaXR5IiwiU2V0IiwiTG9nZ2VyIiwiZm9ybWF0dGVyIiwicHJvY2VzcyIsImVudiIsIk5PREVfRU5WIiwiUFJFVFRZIiwiSlNPTiIsImNvbnNvbGUiLCJzZXJ2aWNlIiwibmFtZSIsInZlcnNpb24iLCJjb25zdHJ1Y3RvciIsIk9iamVjdCIsImZyZWV6ZSIsIndyaXRlIiwic2V2ZXJpdHkiLCJtZXNzYWdlIiwiY29udGV4dCIsImVudHJ5IiwidGltZSIsIkRhdGUiLCJzdHJpbmdpZnkiLCJTdHJpbmciLCJzZXJ2aWNlQ29udGV4dCIsImhhcyIsInJlcG9ydExvY2F0aW9uIiwibG9nIiwiYXNzaWduIiwiZGVidWciLCJpbmZvIiwibm90aWNlIiwid2FybmluZyIsImVycm9yIiwiY3JpdGljYWwiLCJyZXNldCIsImJvbGQiLCJibGFjayIsInJlZCIsImdyZWVuIiwieWVsbG93IiwiZGF0ZU9wdGlvbnMiLCJ5ZWFyIiwibW9udGgiLCJkYXkiLCJob3VyIiwibWludXRlIiwic2Vjb25kIiwiaG91cjEyIiwic3R5bGVzIiwiREVCVUciLCJJTkZPIiwiTk9USUNFIiwiV0FSTklORyIsIkVSUk9SIiwiQ1JJVElDQUwiLCJBTEVSVCIsIkVNRVJHRU5DWSIsInRvTG9jYWxlU3RyaW5nIiwiaHR0cCIsImh0dHBSZXF1ZXN0IiwicmVtb3RlSXAiLCJyZXF1ZXN0TWV0aG9kIiwicmVxdWVzdFVybCIsInN0YXR1cyIsInJlc3BvbnNlU2l6ZSIsInRvVXBwZXJDYXNlIiwiZGVwdGgiLCJjYWxsZXIiLCJnZXQiLCJmaWxlUGF0aCIsInJlbGF0aXZlIiwiY3dkIiwiZ2V0RmlsZU5hbWUiLCJsaW5lTnVtYmVyIiwiZ2V0TGluZU51bWJlciIsImZ1bmN0aW9uTmFtZSIsImdldEZ1bmN0aW9uTmFtZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFFQTs7OztBQUNBOzs7Ozs7QUEwQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBZUEsTUFBTUEsZ0JBQWtDLElBQUlDLEdBQUosQ0FBUSxDQUM5QyxPQUQ4QyxFQUU5QyxVQUY4QyxFQUc5QyxPQUg4QyxFQUk5QyxXQUo4QyxDQUFSLENBQXhDOztJQU9hQyxNLFdBQUFBLE0sR0FBTixNQUFNQSxNQUFOLENBQWE7O0FBaURsQixhQUFXQyxTQUFYLEdBQW9EO0FBQ2xELFdBQU9DLFFBQVFDLEdBQVIsQ0FBWUMsUUFBWixLQUF5QixhQUF6QixHQUF5Q0osT0FBT0ssTUFBaEQsR0FBeURMLE9BQU9NLElBQXZFO0FBQ0Q7O0FBRUQsYUFBV0MsT0FBWCxHQUFzQztBQUNwQyxXQUFPTCxRQUFRQyxHQUFSLENBQVlDLFFBQVosS0FBeUIsTUFBekIsR0FBa0MsNkJBQWxDLEdBQXNERyxPQUE3RDtBQUNEOztBQUVELGFBQVdDLE9BQVgsR0FBcUM7QUFDbkMsV0FBTztBQUNMQSxlQUFTLGtCQUFRQyxJQURaO0FBRUxDLGVBQVMsa0JBQVFBO0FBRlosS0FBUDtBQUlEOztBQUVEQyxjQUFZSixVQUEyQlAsT0FBT08sT0FBOUMsRUFDWU4sWUFBZ0NELE9BQU9DLFNBRG5ELEVBRVlPLFVBQTBCUixPQUFPUSxPQUY3QyxFQUVzRDtBQUNwRCxTQUFLRCxPQUFMLEdBQWVBLE9BQWY7QUFDQSxTQUFLTixTQUFMLEdBQWlCQSxTQUFqQjtBQUNBLFNBQUtPLE9BQUwsR0FBZUEsT0FBZjs7QUFFQUksV0FBT0MsTUFBUCxDQUFjLElBQWQ7QUFDRDs7QUFFREMsUUFBTUMsUUFBTixFQUE2QkMsT0FBN0IsRUFBNkNDLE9BQTdDLEVBQWtFO0FBQ2hFLFVBQU1DLFFBQWtCO0FBQ3RCQyxZQUFNLElBQUlDLElBQUosRUFEZ0I7QUFFdEJKLGVBQVMsT0FBT0EsT0FBUCxLQUFtQixRQUFuQixHQUE4QlYsS0FBS2UsU0FBTCxDQUFlTCxPQUFmLENBQTlCLEdBQXdETSxPQUFPTixPQUFQLENBRjNDO0FBR3RCTyxzQkFBZ0IsS0FBS2YsT0FIQztBQUl0Qk87QUFKc0IsS0FBeEI7O0FBT0EsUUFBSWpCLGNBQWMwQixHQUFkLENBQWtCVCxRQUFsQixDQUFKLEVBQWlDO0FBQy9CRyxZQUFNRCxPQUFOLEdBQWdCLEVBQUNRLGdCQUFnQkEsZ0JBQWpCLEVBQWhCO0FBQ0Q7O0FBRUQsU0FBS2xCLE9BQUwsQ0FBYW1CLEdBQWIsQ0FBaUIsS0FBS3pCLFNBQUwsQ0FBZVcsT0FBT2UsTUFBUCxDQUFjVCxLQUFkLEVBQXFCRCxPQUFyQixDQUFmLENBQWpCO0FBQ0Q7O0FBRURXLFFBQU1aLE9BQU4sRUFBc0JDLFVBQXNCLEVBQTVDLEVBQWdEO0FBQzlDLFNBQUtILEtBQUwsQ0FBVyxPQUFYLEVBQW9CRSxPQUFwQixFQUE2QkMsT0FBN0I7QUFDRDs7QUFFRFksT0FBS2IsT0FBTCxFQUFxQkMsVUFBc0IsRUFBM0MsRUFBK0M7QUFDN0MsU0FBS0gsS0FBTCxDQUFXLE1BQVgsRUFBbUJFLE9BQW5CLEVBQTRCQyxPQUE1QjtBQUNEOztBQUVEYSxTQUFPZCxPQUFQLEVBQXVCQyxVQUFzQixFQUE3QyxFQUFpRDtBQUMvQyxTQUFLSCxLQUFMLENBQVcsUUFBWCxFQUFxQkUsT0FBckIsRUFBOEJDLE9BQTlCO0FBQ0Q7O0FBRURjLFVBQVFmLE9BQVIsRUFBd0JDLFVBQXNCLEVBQTlDLEVBQWtEO0FBQ2hELFNBQUtILEtBQUwsQ0FBVyxTQUFYLEVBQXNCRSxPQUF0QixFQUErQkMsT0FBL0I7QUFDRDs7QUFFRGUsUUFBTWhCLE9BQU4sRUFBc0JDLFVBQXNCLEVBQTVDLEVBQWdEO0FBQzlDLFNBQUtILEtBQUwsQ0FBVyxPQUFYLEVBQW9CRSxPQUFwQixFQUE2QkMsT0FBN0I7QUFDRDs7QUFFRGdCLFdBQVNqQixPQUFULEVBQXlCQyxVQUFzQixFQUEvQyxFQUFtRDtBQUNqRCxTQUFLSCxLQUFMLENBQVcsVUFBWCxFQUF1QkUsT0FBdkIsRUFBZ0NDLE9BQWhDO0FBQ0Q7QUEvR2lCLEM7QUFBUGpCLE0sQ0FLSk0sSSxHQUFPQSxLQUFLZSxTOztBQUxSckIsTSxDQU9KSyxNLEdBQVVhLEtBQUQsSUFBcUI7QUFDbkMsUUFBTWdCLFFBQVEsU0FBZDtBQUNBLFFBQU1DLE9BQU8sU0FBYjs7QUFFQSxRQUFNQyxRQUFRLFVBQWQ7QUFDQSxRQUFNQyxNQUFNLFVBQVo7QUFDQSxRQUFNQyxRQUFRLFVBQWQ7QUFDQSxRQUFNQyxTQUFTLFVBQWY7QUFDQTs7QUFFQSxRQUFNQyxjQUFjO0FBQ2xCQyxVQUFNLFNBRFk7QUFFbEJDLFdBQU8sT0FGVztBQUdsQkMsU0FBSyxTQUhhO0FBSWxCQyxVQUFNLFNBSlk7QUFLbEJDLFlBQVEsU0FMVTtBQU1sQkMsWUFBUSxTQU5VO0FBT2xCQyxZQUFRO0FBUFUsR0FBcEI7O0FBVUEsUUFBTUMsU0FBUztBQUNiQyxXQUFPYixRQUFRRCxJQURGO0FBRWJlLFVBQU1oQixLQUZPO0FBR2JpQixZQUFRYixRQUFRSCxJQUhIO0FBSWJpQixhQUFTYixTQUFTSixJQUpMO0FBS2JrQixXQUFPaEIsTUFBTUYsSUFMQTtBQU1ibUIsY0FBVWpCLE1BQU1GLElBTkg7QUFPYm9CLFdBQU9sQixNQUFNRixJQVBBO0FBUWJxQixlQUFXbkIsTUFBTUY7QUFSSixHQUFmOztBQVdBLFFBQU1oQixPQUFRLElBQUdELE1BQU1DLElBQU4sQ0FBV3NDLGNBQVgsQ0FBMEIsSUFBMUIsRUFBZ0NqQixXQUFoQyxDQUE2QyxHQUE5RDs7QUFFQSxNQUFJa0IsT0FBTyxFQUFYO0FBQ0EsTUFBSXhDLE1BQU15QyxXQUFWLEVBQXVCO0FBQ3JCLFVBQU0sRUFBQ0MsUUFBRCxFQUFXQyxhQUFYLEVBQTBCQyxVQUExQixFQUFzQ0MsTUFBdEMsRUFBOENDLFlBQTlDLEtBQThEOUMsTUFBTXlDLFdBQTFFO0FBQ0FELFdBQVEsR0FBRUUsWUFBWSxTQUFVLE1BQUtDLGNBQWNJLFdBQWQsRUFBNEIsSUFBR0gsVUFBVyxJQUFHQyxNQUFPLElBQUdDLFlBQWEsS0FBekc7QUFDRDs7QUFFRCxTQUFRLEdBQUU3QyxJQUFLLElBQUc2QixPQUFPOUIsTUFBTUgsUUFBYixDQUF1QixHQUFFMkMsSUFBSyxHQUFFeEMsTUFBTUYsT0FBUSxHQUFFa0IsS0FBTSxFQUF4RTtBQUNELEM7O0FBb0VILFNBQVNULGNBQVQsQ0FBd0J5QyxRQUFnQixDQUF4QyxFQUEyRDtBQUN6RCxRQUFNQyxTQUFTLHFCQUFXQyxHQUFYLEdBQWlCRixRQUFRLENBQXpCLENBQWY7O0FBRUEsU0FBTztBQUNMRyxjQUFVLGVBQUtDLFFBQUwsQ0FBY3BFLFFBQVFxRSxHQUFSLEVBQWQsRUFBNkJKLE9BQU9LLFdBQVAsRUFBN0IsQ0FETDtBQUVMQyxnQkFBWU4sT0FBT08sYUFBUCxFQUZQO0FBR0xDLGtCQUFjUixPQUFPUyxlQUFQLE1BQTRCO0FBSHJDLEdBQVA7QUFLRDs7a0JBRWM1RSxNIiwiZmlsZSI6ImxvZ2dlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIEBmbG93ICovXG5pbXBvcnQgcGF0aCBmcm9tIFwicGF0aFwiXG5pbXBvcnQgc3RhY2tUcmFjZSBmcm9tIFwic3RhY2stdHJhY2VcIlxuXG5pbXBvcnQgaG9zdFBrZyBmcm9tIFwiLi9ob3N0LXBrZ1wiXG5pbXBvcnQgTWVtb3J5Q29uc29sZSBmcm9tIFwiLi9tZW1vcnktY29uc29sZVwiXG5cbmV4cG9ydCB0eXBlIExvZ1NldmVyaXR5ID0gKFxuICBcIkRFQlVHXCIgfFxuICBcIklORk9cIiB8XG4gIFwiTk9USUNFXCIgfFxuICBcIldBUk5JTkdcIiB8XG4gIFwiRVJST1JcIiB8XG4gIFwiQ1JJVElDQUxcIiB8XG4gIFwiQUxFUlRcIiB8XG4gIFwiRU1FUkdFTkNZXCJcbilcblxuZXhwb3J0IHR5cGUgSHR0cFJlcXVlc3QgPSB7fFxuICByZXF1ZXN0TWV0aG9kOiBzdHJpbmcsXG4gIHJlcXVlc3RVcmw6IHN0cmluZyxcbiAgcmVxdWVzdFNpemU6IG51bWJlcixcbiAgc3RhdHVzOiBudW1iZXIsXG4gIHJlc3BvbnNlU2l6ZTogbnVtYmVyLFxuICB1c2VyQWdlbnQ/OiBzdHJpbmcsXG4gIHJlbW90ZUlwPzogc3RyaW5nLFxuICByZWZlcmVyPzogc3RyaW5nLFxuICBsYXRlbmN5Pzogc3RyaW5nLFxuICBjYWNoZUhpdD86IGJvb2xlYW4sXG4gIGNhY2hlVmFsaWRhdGVkV2l0aE9yaWdpblNlcnZlcj86IGJvb2xlYW4sXG58fVxuXG5leHBvcnQgdHlwZSBTZXJ2aWNlQ29udGV4dCA9IHt8XG4gIHNlcnZpY2U6IHN0cmluZyxcbiAgdmVyc2lvbj86IHN0cmluZyxcbnx9XG5cbmV4cG9ydCB0eXBlIFJlcG9ydExvY2F0aW9uID0ge3xcbiAgZmlsZVBhdGg6IHN0cmluZyxcbiAgbGluZU51bWJlcj86IG51bWJlcixcbiAgZnVuY3Rpb25OYW1lPzogc3RyaW5nLFxufH1cblxuZXhwb3J0IHR5cGUgQ29udGV4dCA9IHt8XG4gIHJlcG9ydExvY2F0aW9uOiBSZXBvcnRMb2NhdGlvbixcbnx9XG5cbi8qIGh0dHBzOi8vY2xvdWQuZ29vZ2xlLmNvbS9sb2dnaW5nL2RvY3MvcmVmZXJlbmNlL3YyL3Jlc3QvdjIvTG9nRW50cnkgKi9cbi8qIGh0dHBzOi8vZ2l0aHViLmNvbS9Hb29nbGVDbG91ZFBsYXRmb3JtL2ZsdWVudC1wbHVnaW4tZ29vZ2xlLWNsb3VkL2Jsb2IvbWFzdGVyL2xpYi9mbHVlbnQvcGx1Z2luL291dF9nb29nbGVfY2xvdWQucmIgKi9cbi8qIGh0dHBzOi8vZ2l0aHViLmNvbS9Hb29nbGVDbG91ZFBsYXRmb3JtL2ZsdWVudC1wbHVnaW4tZ29vZ2xlLWNsb3VkL2lzc3Vlcy85OSAqL1xuLyogTm90ZSwgdGhpcyBhbHNvIGhhcyB0aGUgY29udGVudHMgb2YganNvblBheWxvYWQsIHNvIGl0IGNhbiBjb250YWluXG4gICBhcmJpdHJhcnkgZmllbGRzISAqL1xuZXhwb3J0IHR5cGUgTG9nRW50cnkgPSB7XG4gIHRpbWU6IERhdGUsXG4gIG1lc3NhZ2U6IHN0cmluZyxcbiAgc2V2ZXJpdHk6IExvZ1NldmVyaXR5LFxuICBodHRwUmVxdWVzdD86IEh0dHBSZXF1ZXN0LFxuICBzZXJ2aWNlQ29udGV4dD86IFNlcnZpY2VDb250ZXh0LFxuICBjb250ZXh0PzogQ29udGV4dCxcbn1cblxuZXhwb3J0IHR5cGUgTG9nQ29udGV4dCA9IHtcbiAgaHR0cFJlcXVlc3Q/OiBIdHRwUmVxdWVzdCxcbn1cblxuY29uc3QgZXJyb3JTZXZlcml0eTogU2V0PExvZ1NldmVyaXR5PiA9IG5ldyBTZXQoW1xuICBcIkVSUk9SXCIsXG4gIFwiQ1JJVElDQUxcIixcbiAgXCJBTEVSVFwiLFxuICBcIkVNRVJHRU5DWVwiLFxuXSlcblxuZXhwb3J0IGNsYXNzIExvZ2dlciB7XG4gIGNvbnNvbGU6IGNvbnNvbGUuQ29uc29sZVxuICBmb3JtYXR0ZXI6IExvZ0VudHJ5ID0+IHN0cmluZ1xuICBzZXJ2aWNlOiBTZXJ2aWNlQ29udGV4dFxuXG4gIHN0YXRpYyBKU09OID0gSlNPTi5zdHJpbmdpZnlcblxuICBzdGF0aWMgUFJFVFRZID0gKGVudHJ5OiBMb2dFbnRyeSkgPT4ge1xuICAgIGNvbnN0IHJlc2V0ID0gXCJcXHgxYlswbVwiXG4gICAgY29uc3QgYm9sZCA9IFwiXFx4MWJbMW1cIlxuXG4gICAgY29uc3QgYmxhY2sgPSBcIlxceDFiWzMwbVwiXG4gICAgY29uc3QgcmVkID0gXCJcXHgxYlszMW1cIlxuICAgIGNvbnN0IGdyZWVuID0gXCJcXHgxYlszMm1cIlxuICAgIGNvbnN0IHllbGxvdyA9IFwiXFx4MWJbMzNtXCJcbiAgICAvLyBjb25zdCBibHVlID0gXCJcXHgxYlszNG1cIlxuXG4gICAgY29uc3QgZGF0ZU9wdGlvbnMgPSB7XG4gICAgICB5ZWFyOiBcIm51bWVyaWNcIixcbiAgICAgIG1vbnRoOiBcInNob3J0XCIsXG4gICAgICBkYXk6IFwibnVtZXJpY1wiLFxuICAgICAgaG91cjogXCIyLWRpZ2l0XCIsXG4gICAgICBtaW51dGU6IFwiMi1kaWdpdFwiLFxuICAgICAgc2Vjb25kOiBcIjItZGlnaXRcIixcbiAgICAgIGhvdXIxMjogZmFsc2UsXG4gICAgfVxuXG4gICAgY29uc3Qgc3R5bGVzID0ge1xuICAgICAgREVCVUc6IGJsYWNrICsgYm9sZCxcbiAgICAgIElORk86IHJlc2V0LFxuICAgICAgTk9USUNFOiBncmVlbiArIGJvbGQsXG4gICAgICBXQVJOSU5HOiB5ZWxsb3cgKyBib2xkLFxuICAgICAgRVJST1I6IHJlZCArIGJvbGQsXG4gICAgICBDUklUSUNBTDogcmVkICsgYm9sZCxcbiAgICAgIEFMRVJUOiByZWQgKyBib2xkLFxuICAgICAgRU1FUkdFTkNZOiByZWQgKyBib2xkLFxuICAgIH1cblxuICAgIGNvbnN0IHRpbWUgPSBgWyR7ZW50cnkudGltZS50b0xvY2FsZVN0cmluZyhcImVuXCIsIGRhdGVPcHRpb25zKX1dYFxuXG4gICAgbGV0IGh0dHAgPSBcIlwiXG4gICAgaWYgKGVudHJ5Lmh0dHBSZXF1ZXN0KSB7XG4gICAgICBjb25zdCB7cmVtb3RlSXAsIHJlcXVlc3RNZXRob2QsIHJlcXVlc3RVcmwsIHN0YXR1cywgcmVzcG9uc2VTaXplfSA9IGVudHJ5Lmh0dHBSZXF1ZXN0XG4gICAgICBodHRwID0gYCR7cmVtb3RlSXAgfHwgXCJ1bmtub3duXCJ9IC0gJHtyZXF1ZXN0TWV0aG9kLnRvVXBwZXJDYXNlKCl9ICR7cmVxdWVzdFVybH0gJHtzdGF0dXN9ICR7cmVzcG9uc2VTaXplfSAtIGBcbiAgICB9XG5cbiAgICByZXR1cm4gYCR7dGltZX0gJHtzdHlsZXNbZW50cnkuc2V2ZXJpdHldfSR7aHR0cH0ke2VudHJ5Lm1lc3NhZ2V9JHtyZXNldH1gXG4gIH1cblxuICBzdGF0aWMgZ2V0IGZvcm1hdHRlcigpOiAoZW50cnk6IExvZ0VudHJ5KSA9PiBzdHJpbmcge1xuICAgIHJldHVybiBwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gXCJkZXZlbG9wbWVudFwiID8gTG9nZ2VyLlBSRVRUWSA6IExvZ2dlci5KU09OXG4gIH1cblxuICBzdGF0aWMgZ2V0IGNvbnNvbGUoKTogY29uc29sZS5Db25zb2xlIHtcbiAgICByZXR1cm4gcHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09IFwidGVzdFwiID8gbmV3IE1lbW9yeUNvbnNvbGUgOiBjb25zb2xlXG4gIH1cblxuICBzdGF0aWMgZ2V0IHNlcnZpY2UoKTogU2VydmljZUNvbnRleHQge1xuICAgIHJldHVybiB7XG4gICAgICBzZXJ2aWNlOiBob3N0UGtnLm5hbWUsXG4gICAgICB2ZXJzaW9uOiBob3N0UGtnLnZlcnNpb24sXG4gICAgfVxuICB9XG5cbiAgY29uc3RydWN0b3IoY29uc29sZTogY29uc29sZS5Db25zb2xlID0gTG9nZ2VyLmNvbnNvbGUsXG4gICAgICAgICAgICAgIGZvcm1hdHRlcjogTG9nRW50cnkgPT4gc3RyaW5nID0gTG9nZ2VyLmZvcm1hdHRlcixcbiAgICAgICAgICAgICAgc2VydmljZTogU2VydmljZUNvbnRleHQgPSBMb2dnZXIuc2VydmljZSkge1xuICAgIHRoaXMuY29uc29sZSA9IGNvbnNvbGVcbiAgICB0aGlzLmZvcm1hdHRlciA9IGZvcm1hdHRlclxuICAgIHRoaXMuc2VydmljZSA9IHNlcnZpY2VcblxuICAgIE9iamVjdC5mcmVlemUodGhpcylcbiAgfVxuXG4gIHdyaXRlKHNldmVyaXR5OiBMb2dTZXZlcml0eSwgbWVzc2FnZTogbWl4ZWQsIGNvbnRleHQ6IExvZ0NvbnRleHQpIHtcbiAgICBjb25zdCBlbnRyeTogTG9nRW50cnkgPSB7XG4gICAgICB0aW1lOiBuZXcgRGF0ZSxcbiAgICAgIG1lc3NhZ2U6IHR5cGVvZiBtZXNzYWdlID09PSBcIm9iamVjdFwiID8gSlNPTi5zdHJpbmdpZnkobWVzc2FnZSkgOiBTdHJpbmcobWVzc2FnZSksXG4gICAgICBzZXJ2aWNlQ29udGV4dDogdGhpcy5zZXJ2aWNlLFxuICAgICAgc2V2ZXJpdHksXG4gICAgfVxuXG4gICAgaWYgKGVycm9yU2V2ZXJpdHkuaGFzKHNldmVyaXR5KSkge1xuICAgICAgZW50cnkuY29udGV4dCA9IHtyZXBvcnRMb2NhdGlvbjogcmVwb3J0TG9jYXRpb24oKX1cbiAgICB9XG5cbiAgICB0aGlzLmNvbnNvbGUubG9nKHRoaXMuZm9ybWF0dGVyKE9iamVjdC5hc3NpZ24oZW50cnksIGNvbnRleHQpKSlcbiAgfVxuXG4gIGRlYnVnKG1lc3NhZ2U6IG1peGVkLCBjb250ZXh0OiBMb2dDb250ZXh0ID0ge30pIHtcbiAgICB0aGlzLndyaXRlKFwiREVCVUdcIiwgbWVzc2FnZSwgY29udGV4dClcbiAgfVxuXG4gIGluZm8obWVzc2FnZTogbWl4ZWQsIGNvbnRleHQ6IExvZ0NvbnRleHQgPSB7fSkge1xuICAgIHRoaXMud3JpdGUoXCJJTkZPXCIsIG1lc3NhZ2UsIGNvbnRleHQpXG4gIH1cblxuICBub3RpY2UobWVzc2FnZTogbWl4ZWQsIGNvbnRleHQ6IExvZ0NvbnRleHQgPSB7fSkge1xuICAgIHRoaXMud3JpdGUoXCJOT1RJQ0VcIiwgbWVzc2FnZSwgY29udGV4dClcbiAgfVxuXG4gIHdhcm5pbmcobWVzc2FnZTogbWl4ZWQsIGNvbnRleHQ6IExvZ0NvbnRleHQgPSB7fSkge1xuICAgIHRoaXMud3JpdGUoXCJXQVJOSU5HXCIsIG1lc3NhZ2UsIGNvbnRleHQpXG4gIH1cblxuICBlcnJvcihtZXNzYWdlOiBtaXhlZCwgY29udGV4dDogTG9nQ29udGV4dCA9IHt9KSB7XG4gICAgdGhpcy53cml0ZShcIkVSUk9SXCIsIG1lc3NhZ2UsIGNvbnRleHQpXG4gIH1cblxuICBjcml0aWNhbChtZXNzYWdlOiBtaXhlZCwgY29udGV4dDogTG9nQ29udGV4dCA9IHt9KSB7XG4gICAgdGhpcy53cml0ZShcIkNSSVRJQ0FMXCIsIG1lc3NhZ2UsIGNvbnRleHQpXG4gIH1cbn1cblxuXG5mdW5jdGlvbiByZXBvcnRMb2NhdGlvbihkZXB0aDogbnVtYmVyID0gMik6IFJlcG9ydExvY2F0aW9uIHtcbiAgY29uc3QgY2FsbGVyID0gc3RhY2tUcmFjZS5nZXQoKVtkZXB0aCArIDFdXG5cbiAgcmV0dXJuIHtcbiAgICBmaWxlUGF0aDogcGF0aC5yZWxhdGl2ZShwcm9jZXNzLmN3ZCgpLCBjYWxsZXIuZ2V0RmlsZU5hbWUoKSksXG4gICAgbGluZU51bWJlcjogY2FsbGVyLmdldExpbmVOdW1iZXIoKSxcbiAgICBmdW5jdGlvbk5hbWU6IGNhbGxlci5nZXRGdW5jdGlvbk5hbWUoKSB8fCBcIjxhbm9ueW1vdXM+XCIsXG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgTG9nZ2VyXG4iXX0=