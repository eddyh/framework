"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = requireAuthorization;

var _crypto = require("crypto");

var _errors = require("../errors");

/* eslint-disable no-unused-expressions */
function requireAuthorization(realm, credentials) {
  return function requireAuthorization(next) {
    this;

    const { username, password } = this.data;
    if (username) {
      const expected = credentials[username];
      if (safeEqual(password, expected)) {
        return next();
      }
    }

    this.set("WWW-Authenticate", `Basic realm="${realm}"`);
    throw new _errors.Unauthorized();
  };
}

function safeEqual(a, b) {
  return a !== undefined && b !== undefined && a.length === b.length && (0, _crypto.timingSafeEqual)(Buffer.from(a), Buffer.from(b));
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWRkbGV3YXJlL3JlcXVpcmUtYXV0aG9yaXphdGlvbi5qcyJdLCJuYW1lcyI6WyJyZXF1aXJlQXV0aG9yaXphdGlvbiIsInJlYWxtIiwiY3JlZGVudGlhbHMiLCJuZXh0IiwidXNlcm5hbWUiLCJwYXNzd29yZCIsImRhdGEiLCJleHBlY3RlZCIsInNhZmVFcXVhbCIsInNldCIsIlVuYXV0aG9yaXplZCIsImEiLCJiIiwidW5kZWZpbmVkIiwibGVuZ3RoIiwiQnVmZmVyIiwiZnJvbSJdLCJtYXBwaW5ncyI6Ijs7Ozs7a0JBT3dCQSxvQjs7QUFMeEI7O0FBR0E7O0FBSkE7QUFNZSxTQUFTQSxvQkFBVCxDQUE4QkMsS0FBOUIsRUFBNkNDLFdBQTdDLEVBQW9HO0FBQ2pILFNBQU8sU0FBU0Ysb0JBQVQsQ0FBOEJHLElBQTlCLEVBQTBDO0FBQzlDLFFBQUQ7O0FBRUEsVUFBTSxFQUFDQyxRQUFELEVBQVdDLFFBQVgsS0FBdUIsS0FBS0MsSUFBbEM7QUFDQSxRQUFJRixRQUFKLEVBQWM7QUFDWixZQUFNRyxXQUFXTCxZQUFZRSxRQUFaLENBQWpCO0FBQ0EsVUFBSUksVUFBVUgsUUFBVixFQUFvQkUsUUFBcEIsQ0FBSixFQUFtQztBQUNqQyxlQUFPSixNQUFQO0FBQ0Q7QUFDRjs7QUFFRCxTQUFLTSxHQUFMLENBQVMsa0JBQVQsRUFBOEIsZ0JBQWVSLEtBQU0sR0FBbkQ7QUFDQSxVQUFNLElBQUlTLG9CQUFKLEVBQU47QUFDRCxHQWJEO0FBY0Q7O0FBRUQsU0FBU0YsU0FBVCxDQUFtQkcsQ0FBbkIsRUFBcUNDLENBQXJDLEVBQWdFO0FBQzlELFNBQU9ELE1BQU1FLFNBQU4sSUFBbUJELE1BQU1DLFNBQXpCLElBQXNDRixFQUFFRyxNQUFGLEtBQWFGLEVBQUVFLE1BQXJELElBQ0wsNkJBQWdCQyxPQUFPQyxJQUFQLENBQVlMLENBQVosQ0FBaEIsRUFBZ0NJLE9BQU9DLElBQVAsQ0FBWUosQ0FBWixDQUFoQyxDQURGO0FBRUQiLCJmaWxlIjoicmVxdWlyZS1hdXRob3JpemF0aW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyogQGZsb3cgKi9cbi8qIGVzbGludC1kaXNhYmxlIG5vLXVudXNlZC1leHByZXNzaW9ucyAqL1xuaW1wb3J0IHt0aW1pbmdTYWZlRXF1YWx9IGZyb20gXCJjcnlwdG9cIlxuaW1wb3J0IHR5cGUge0NvbnRleHQsIE5leHQsIE1pZGRsZXdhcmV9IGZyb20gXCIuLi9taWRkbGV3YXJlXCJcblxuaW1wb3J0IHtVbmF1dGhvcml6ZWR9IGZyb20gXCIuLi9lcnJvcnNcIlxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiByZXF1aXJlQXV0aG9yaXphdGlvbihyZWFsbTogc3RyaW5nLCBjcmVkZW50aWFsczoge1t1c2VybmFtZTogc3RyaW5nXTogc3RyaW5nfSk6IE1pZGRsZXdhcmUge1xuICByZXR1cm4gZnVuY3Rpb24gcmVxdWlyZUF1dGhvcml6YXRpb24obmV4dDogTmV4dCkge1xuICAgICh0aGlzOiBDb250ZXh0KVxuXG4gICAgY29uc3Qge3VzZXJuYW1lLCBwYXNzd29yZH0gPSB0aGlzLmRhdGFcbiAgICBpZiAodXNlcm5hbWUpIHtcbiAgICAgIGNvbnN0IGV4cGVjdGVkID0gY3JlZGVudGlhbHNbdXNlcm5hbWVdXG4gICAgICBpZiAoc2FmZUVxdWFsKHBhc3N3b3JkLCBleHBlY3RlZCkpIHtcbiAgICAgICAgcmV0dXJuIG5leHQoKVxuICAgICAgfVxuICAgIH1cblxuICAgIHRoaXMuc2V0KFwiV1dXLUF1dGhlbnRpY2F0ZVwiLCBgQmFzaWMgcmVhbG09XCIke3JlYWxtfVwiYClcbiAgICB0aHJvdyBuZXcgVW5hdXRob3JpemVkXG4gIH1cbn1cblxuZnVuY3Rpb24gc2FmZUVxdWFsKGE6IHN0cmluZyB8IHZvaWQsIGI6IHN0cmluZyB8IHZvaWQpOiBib29sZWFuIHtcbiAgcmV0dXJuIGEgIT09IHVuZGVmaW5lZCAmJiBiICE9PSB1bmRlZmluZWQgJiYgYS5sZW5ndGggPT09IGIubGVuZ3RoICYmXG4gICAgdGltaW5nU2FmZUVxdWFsKEJ1ZmZlci5mcm9tKGEpLCBCdWZmZXIuZnJvbShiKSlcbn1cbiJdfQ==