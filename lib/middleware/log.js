"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = log;

var _http = require("http");

var _http2 = _interopRequireDefault(_http);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const statusCodes = new Map();
/* eslint-disable dot-notation */
/* eslint-disable no-unused-expressions */

for (const code in _http2.default.STATUS_CODES) {
  const number = parseInt(code);
  statusCodes.set(number, _http2.default.STATUS_CODES[number].toLowerCase());
}

function log(logger) {
  return function log(next) {
    this;

    const socket = this.request.socket;

    /* Check what has been previously recorded as read/written on this socket.
       The request may not be the first over this socket. */
    const bytesReadPreviously = socket.bytesReadPreviously || 0;
    const bytesWrittenPreviously = socket.bytesWrittenPreviously || 0;

    const startTime = process.hrtime();

    this.data.log = Object.create(null);

    this.response.on("finish", () => {
      /* Store current read/written count for future reference. */
      socket.bytesReadPreviously = socket.bytesRead;
      socket.bytesWrittenPreviously = socket.bytesWritten;

      const requestMethod = this.method;
      const requestUrl = this.url;
      const requestSize = socket.bytesRead - bytesReadPreviously;

      const status = this.response.statusCode;
      const responseSize = socket.bytesWritten - bytesWrittenPreviously;

      const userAgent = this.get("user-agent");
      const referer = this.get("referer");

      const [sec, nano] = process.hrtime(startTime);
      const latency = `${(sec + 1e-9 * nano).toFixed(3)}s`;

      let remoteIp = socket.remoteAddress;
      const forwarded = this.get("x-forwarded-for");
      if (forwarded) {
        remoteIp = forwarded.split(",").shift();
      }

      const httpRequest = {
        requestMethod,
        requestUrl,
        requestSize,
        status,
        responseSize,
        userAgent,
        remoteIp,
        referer,
        latency
        // protocol, TODO
      };

      const logContext = Object.assign({}, this.data.log, { httpRequest });

      if (status >= 500 && this.data.error) {
        /* An error was thrown somewhere. */
        if (this.data.error.expose) {
          /* This error is exposable, so it is to be expected. */
          logger.warning(this.data.error.message || "(no message)", logContext);
        } else {
          /* This was an internal error, not supposed to be exposed. Log the
             entire stack trace so we can debug later. */
          logger.error(this.data.error.stack || this.data.error.toString(), logContext);
        }
      } else {
        /* No error was thrown, or error was in 4xx range. */
        logger.info(statusCodes.get(status), logContext);
      }
    });

    return next();
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWRkbGV3YXJlL2xvZy5qcyJdLCJuYW1lcyI6WyJsb2ciLCJzdGF0dXNDb2RlcyIsIk1hcCIsImNvZGUiLCJTVEFUVVNfQ09ERVMiLCJudW1iZXIiLCJwYXJzZUludCIsInNldCIsInRvTG93ZXJDYXNlIiwibG9nZ2VyIiwibmV4dCIsInNvY2tldCIsInJlcXVlc3QiLCJieXRlc1JlYWRQcmV2aW91c2x5IiwiYnl0ZXNXcml0dGVuUHJldmlvdXNseSIsInN0YXJ0VGltZSIsInByb2Nlc3MiLCJocnRpbWUiLCJkYXRhIiwiT2JqZWN0IiwiY3JlYXRlIiwicmVzcG9uc2UiLCJvbiIsImJ5dGVzUmVhZCIsImJ5dGVzV3JpdHRlbiIsInJlcXVlc3RNZXRob2QiLCJtZXRob2QiLCJyZXF1ZXN0VXJsIiwidXJsIiwicmVxdWVzdFNpemUiLCJzdGF0dXMiLCJzdGF0dXNDb2RlIiwicmVzcG9uc2VTaXplIiwidXNlckFnZW50IiwiZ2V0IiwicmVmZXJlciIsInNlYyIsIm5hbm8iLCJsYXRlbmN5IiwidG9GaXhlZCIsInJlbW90ZUlwIiwicmVtb3RlQWRkcmVzcyIsImZvcndhcmRlZCIsInNwbGl0Iiwic2hpZnQiLCJodHRwUmVxdWVzdCIsImxvZ0NvbnRleHQiLCJhc3NpZ24iLCJlcnJvciIsImV4cG9zZSIsIndhcm5pbmciLCJtZXNzYWdlIiwic3RhY2siLCJ0b1N0cmluZyIsImluZm8iXSwibWFwcGluZ3MiOiI7Ozs7O2tCQW1Cd0JBLEc7O0FBaEJ4Qjs7Ozs7O0FBVUEsTUFBTUMsY0FBbUMsSUFBSUMsR0FBSixFQUF6QztBQVpBO0FBQ0E7O0FBWUEsS0FBSyxNQUFNQyxJQUFYLElBQW1CLGVBQUtDLFlBQXhCLEVBQXNDO0FBQ3BDLFFBQU1DLFNBQVNDLFNBQVNILElBQVQsQ0FBZjtBQUNBRixjQUFZTSxHQUFaLENBQWdCRixNQUFoQixFQUF3QixlQUFLRCxZQUFMLENBQWtCQyxNQUFsQixFQUEwQkcsV0FBMUIsRUFBeEI7QUFDRDs7QUFFYyxT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Y2VzQ29udGVudCI6WyIvKiBAZmxvdyAqL1xuLyogZXNsaW50LWRpc2FibGUgZG90LW5vdGF0aW9uICovXG4vKiBlc2xpbnQtZGlzYWJsZSBuby11bnVzZWQtZXhwcmVzc2lvbnMgKi9cbmltcG9ydCBodHRwIGZyb20gXCJodHRwXCJcblxuaW1wb3J0IHR5cGUge0NvbnRleHQsIE5leHQsIE1pZGRsZXdhcmV9IGZyb20gXCIuLi9taWRkbGV3YXJlXCJcbmltcG9ydCB0eXBlIHtIdHRwUmVxdWVzdCwgTG9nQ29udGV4dCwgTG9nZ2VyfSBmcm9tIFwiLi4vdXRpbC9sb2dnZXJcIlxuXG50eXBlIFN0YXRzU29ja2V0ID0gbmV0JFNvY2tldCAmIHtcbiAgYnl0ZXNSZWFkUHJldmlvdXNseT86IG51bWJlcixcbiAgYnl0ZXNXcml0dGVuUHJldmlvdXNseT86IG51bWJlcixcbn1cblxuY29uc3Qgc3RhdHVzQ29kZXM6IE1hcDxudW1iZXIsIHN0cmluZz4gPSBuZXcgTWFwXG5mb3IgKGNvbnN0IGNvZGUgaW4gaHR0cC5TVEFUVVNfQ09ERVMpIHtcbiAgY29uc3QgbnVtYmVyID0gcGFyc2VJbnQoY29kZSlcbiAgc3RhdHVzQ29kZXMuc2V0KG51bWJlciwgaHR0cC5TVEFUVVNfQ09ERVNbbnVtYmVyXS50b0xvd2VyQ2FzZSgpKVxufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBsb2cobG9nZ2VyOiBMb2dnZXIpOiBNaWRkbGV3YXJlIHtcbiAgcmV0dXJuIGZ1bmN0aW9uIGxvZyhuZXh0OiBOZXh0KSB7XG4gICAgKHRoaXM6IENvbnRleHQpXG5cbiAgICBjb25zdCBzb2NrZXQ6IFN0YXRzU29ja2V0ID0gdGhpcy5yZXF1ZXN0LnNvY2tldFxuXG4gICAgLyogQ2hlY2sgd2hhdCBoYXMgYmVlbiBwcmV2aW91c2x5IHJlY29yZGVkIGFzIHJlYWQvd3JpdHRlbiBvbiB0aGlzIHNvY2tldC5cbiAgICAgICBUaGUgcmVxdWVzdCBtYXkgbm90IGJlIHRoZSBmaXJzdCBvdmVyIHRoaXMgc29ja2V0LiAqL1xuICAgIGNvbnN0IGJ5dGVzUmVhZFByZXZpb3VzbHkgPSBzb2NrZXQuYnl0ZXNSZWFkUHJldmlvdXNseSB8fCAwXG4gICAgY29uc3QgYnl0ZXNXcml0dGVuUHJldmlvdXNseSA9IHNvY2tldC5ieXRlc1dyaXR0ZW5QcmV2aW91c2x5IHx8IDBcblxuICAgIGNvbnN0IHN0YXJ0VGltZSA9IHByb2Nlc3MuaHJ0aW1lKClcblxuICAgIHRoaXMuZGF0YS5sb2cgPSBPYmplY3QuY3JlYXRlKG51bGwpXG5cbiAgICB0aGlzLnJlc3BvbnNlLm9uKFwiZmluaXNoXCIsICgpID0+IHtcbiAgICAgIC8qIFN0b3JlIGN1cnJlbnQgcmVhZC93cml0dGVuIGNvdW50IGZvciBmdXR1cmUgcmVmZXJlbmNlLiAqL1xuICAgICAgc29ja2V0LmJ5dGVzUmVhZFByZXZpb3VzbHkgPSBzb2NrZXQuYnl0ZXNSZWFkXG4gICAgICBzb2NrZXQuYnl0ZXNXcml0dGVuUHJldmlvdXNseSA9IHNvY2tldC5ieXRlc1dyaXR0ZW5cblxuICAgICAgY29uc3QgcmVxdWVzdE1ldGhvZCA9IHRoaXMubWV0aG9kXG4gICAgICBjb25zdCByZXF1ZXN0VXJsID0gdGhpcy51cmxcbiAgICAgIGNvbnN0IHJlcXVlc3RTaXplID0gc29ja2V0LmJ5dGVzUmVhZCAtIGJ5dGVzUmVhZFByZXZpb3VzbHlcblxuICAgICAgY29uc3Qgc3RhdHVzID0gdGhpcy5yZXNwb25zZS5zdGF0dXNDb2RlXG4gICAgICBjb25zdCByZXNwb25zZVNpemUgPSBzb2NrZXQuYnl0ZXNXcml0dGVuIC0gYnl0ZXNXcml0dGVuUHJldmlvdXNseVxuXG4gICAgICBjb25zdCB1c2VyQWdlbnQgPSB0aGlzLmdldChcInVzZXItYWdlbnRcIilcbiAgICAgIGNvbnN0IHJlZmVyZXIgPSB0aGlzLmdldChcInJlZmVyZXJcIilcblxuICAgICAgY29uc3QgW3NlYywgbmFub10gPSBwcm9jZXNzLmhydGltZShzdGFydFRpbWUpXG4gICAgICBjb25zdCBsYXRlbmN5ID0gYCR7KHNlYyArIDFlLTkgKiBuYW5vKS50b0ZpeGVkKDMpfXNgXG5cbiAgICAgIGxldCByZW1vdGVJcCA9IHNvY2tldC5yZW1vdGVBZGRyZXNzXG4gICAgICBjb25zdCBmb3J3YXJkZWQgPSB0aGlzLmdldChcIngtZm9yd2FyZGVkLWZvclwiKVxuICAgICAgaWYgKGZvcndhcmRlZCkge1xuICAgICAgICByZW1vdGVJcCA9IGZvcndhcmRlZC5zcGxpdChcIixcIikuc2hpZnQoKVxuICAgICAgfVxuXG4gICAgICBjb25zdCBodHRwUmVxdWVzdDogSHR0cFJlcXVlc3QgPSB7XG4gICAgICAgIHJlcXVlc3RNZXRob2QsXG4gICAgICAgIHJlcXVlc3RVcmwsXG4gICAgICAgIHJlcXVlc3RTaXplLFxuICAgICAgICBzdGF0dXMsXG4gICAgICAgIHJlc3BvbnNlU2l6ZSxcbiAgICAgICAgdXNlckFnZW50LFxuICAgICAgICByZW1vdGVJcCxcbiAgICAgICAgcmVmZXJlcixcbiAgICAgICAgbGF0ZW5jeSxcbiAgICAgICAgLy8gcHJvdG9jb2wsIFRPRE9cbiAgICAgIH1cblxuICAgICAgY29uc3QgbG9nQ29udGV4dDogTG9nQ29udGV4dCA9IE9iamVjdC5hc3NpZ24oe30sIHRoaXMuZGF0YS5sb2csIHtodHRwUmVxdWVzdH0pXG5cbiAgICAgIGlmIChzdGF0dXMgPj0gNTAwICYmIHRoaXMuZGF0YS5lcnJvcikge1xuICAgICAgICAvKiBBbiBlcnJvciB3YXMgdGhyb3duIHNvbWV3aGVyZS4gKi9cbiAgICAgICAgaWYgKHRoaXMuZGF0YS5lcnJvci5leHBvc2UpIHtcbiAgICAgICAgICAvKiBUaGlzIGVycm9yIGlzIGV4cG9zYWJsZSwgc28gaXQgaXMgdG8gYmUgZXhwZWN0ZWQuICovXG4gICAgICAgICAgbG9nZ2VyLndhcm5pbmcodGhpcy5kYXRhLmVycm9yLm1lc3NhZ2UgfHwgXCIobm8gbWVzc2FnZSlcIiwgbG9nQ29udGV4dClcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvKiBUaGlzIHdhcyBhbiBpbnRlcm5hbCBlcnJvciwgbm90IHN1cHBvc2VkIHRvIGJlIGV4cG9zZWQuIExvZyB0aGVcbiAgICAgICAgICAgICBlbnRpcmUgc3RhY2sgdHJhY2Ugc28gd2UgY2FuIGRlYnVnIGxhdGVyLiAqL1xuICAgICAgICAgIGxvZ2dlci5lcnJvcih0aGlzLmRhdGEuZXJyb3Iuc3RhY2sgfHwgdGhpcy5kYXRhLmVycm9yLnRvU3RyaW5nKCksIGxvZ0NvbnRleHQpXG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8qIE5vIGVycm9yIHdhcyB0aHJvd24sIG9yIGVycm9yIHdhcyBpbiA0eHggcmFuZ2UuICovXG4gICAgICAgIGxvZ2dlci5pbmZvKHN0YXR1c0NvZGVzLmdldChzdGF0dXMpLCBsb2dDb250ZXh0KVxuICAgICAgfVxuICAgIH0pXG5cbiAgICByZXR1cm4gbmV4dCgpXG4gIH1cbn1cbiJdfQ==